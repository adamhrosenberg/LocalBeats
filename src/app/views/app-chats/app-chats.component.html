<mat-card class="p-0" style="background-color: rgb(255, 255, 255); border-radius: 25px; margin: 10px 10px 15px; box-shadow: rgba(150, 150, 150, 0.2) 0px 10px 6px -6px; border-style: solid; border-color: rgba(245, 245, 245, 0.9); border-width: 1px; padding: 10px;">
  <mat-sidenav-container class="chat-container" style="background-color: rgba(245,245,245, 0.9);">
    <!-- Left sidebar -->
    <mat-sidenav class="chat-sidenav" #chatSidebar [opened]="isSidenavOpen" mode="side">
      <!-- Left side topbar -->
      <mat-toolbar color="primary" class="chat-sidebar-toolbar">
        <button mat-button (click)="onStartNewConversationButtonClick()">Start new conversation</button>
        <!-- <a href="" class="toolbar-avatar online">
          <img [src]="loggedInUser.profilePicUrl" alt="">
          <span class="status-dot"></span>
        </a> -->
      </mat-toolbar>
      <!-- Left side contact list -->
      <mat-nav-list class="inbox-nav-list" role="list">
        <mat-list-item *ngFor="let user of connectedUsers" (click)="changeActiveUser(user)">
          <a mat-list-avatar [ngClass]="{online: user.isOnline}" class="toolbar-avatar">
            <img [src]="user.profilePicUrl" alt="">
            <span class="status-dot"></span>
          </a>
          <h6 matLine>{{user.firstName + ' ' + user.lastName}}</h6>
          <!-- CHANGE TO INTERPOLATION ! <p matLine class="text-muted">{{user.lastMsg}}</p> -->
          <!--<p matLine class="text-muted">{{this.activeChatMessages[this.activeChatMessages.length - 1]}}</p>-->
        </mat-list-item>

      </mat-nav-list>
    </mat-sidenav>

    <!-- Right side -->
    <div class="chats-wrap" style="min-height: 550px; max-height:650px">
      <!-- Right side topbar -->
      <mat-toolbar color="primary" class="chat-toolbar mb-1" style="position: sticky; top: 0px; flex-direction: row; box-sizing: border-box; display: flex;">
        <!-- sidebar toggle button -->
        <button mat-icon-button [style.alignSelf]="'center'" class="mr-1" (click)="chatSidebar.toggle()">
          <mat-icon>short_text</mat-icon>
        </button>

        <!-- Selected active user: on topbar, the current recipient -->
        <div *ngIf="newConversationClicked; then newConversationTemplate else existingConversationTemplate"></div>
        <ng-template #newConversationTemplate>
          <div class="active-chat-user" fxLayout="row" fxLayoutAlign="start center">

            <div fxLayout="column">
              <!-- Need to add ngIF here, where if isNewConversation=true, then show this, else show normal name thingy-->
              <form class="newConversationForm">
                <mat-form-field class="new-conversation-form">

                  <mat-chip-list #chipList>
                    <mat-chip *ngFor="let fruit of recipientChips" [selectable]="isSelectable" [removable]="isRemovable" (remove)="remove(fruit)">
                      {{fruit.name}}
                      <mat-icon matChipRemove *ngIf="isRemovable">cancel</mat-icon>
                    </mat-chip>

                    <input [(ngModel)]="recipientStringAny" placeholder="Recipient(s)" aria-label="Recipient" matInput [formControl]="recipientsFormControl"
                      [matAutocomplete]="auto" [matChipInputFor]="chipList" [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                      [matChipInputAddOnBlur]="isAddOnBlur" (matChipInputTokenEnd)="add($event)">
                    <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
                      <mat-option *ngFor="let option of filteredOptions | async" [value]="option">
                        {{ option.email }}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-chip-list>
                </mat-form-field>
              </form>
            </div>
          </div>
        </ng-template>


        <!-- Here is where the profile pic is displayed -->

        <ng-template #existingConversationTemplate>
          <!-- <div *ngIf="this.connectedUsers.length === 0; then blankConversationTemplate else activeConversationTemplate"></div> -->

          <!-- <ng-template #activeConversationTemplate> -->
            <div class="active-chat-user" fxLayout="row" fxLayoutAlign="start center">
              <a [ngClass]="{online: activeChatUser.isOnline}" class="toolbar-avatar mr-1">
                <img [src]="activeChatUser.profilePicUrl" alt="">
                <span class="status-dot"></span>
              </a>
              <div fxLayout="column">
                <!-- Here is where the name is displayed -->
                <h6 class="m-0 font-normal fz-1">{{activeChatUser.firstName + ' ' + activeChatUser.lastName}}</h6>

              </div>
            </div>
          <!-- </ng-template>
          <ng-template #blankConversationTemplate>
            <div>NOTHING</div>
          </ng-template> -->
        </ng-template>



        <!-- Right side top menu -->
        <span fxFlex></span>
        <button [style.alignSelf]="'center'" mat-icon-button [matMenuTriggerFor]="toolbarDDMenu" class="topbar-button-right hidden-on-open">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #toolbarDDMenu="matMenu">
          <button mat-menu-item>
            <mat-icon>account_circle</mat-icon>Contact info</button>
          <button mat-menu-item>
            <mat-icon>volume_mute</mat-icon>Mute</button>
          <button mat-menu-item>
            <mat-icon>delete</mat-icon>Clear chat</button>
        </mat-menu>
      </mat-toolbar>

      <!-- Main chat body -->
      <div class="conversations-hold" style="min-height: 500px; position: sticky; top:0; z-index: -1;">
        <!-- single chat item -->
        <div *ngFor="let message of activeChatMessages" class="single-conversation {{ !!(message.from._id == this.loggedInUser._id) ? 
                                      ('me') : 
                                      ('sender')}}" fxLayout="row">
          <a href="" class="toolbar-avatar online" [@flyInOut]="'in'">
            <img [src]="!!(message.from._id == this.loggedInUser._id) ? 
                        (this.loggedInUser.profilePicUrl) : 
                        (message.from.profilePicUrl)" alt="" [@flyInOut]="'in'">
            <span class="status-dot" [@flyInOut]="'in'"></span>
          </a>
          <div>
            <!-- <h5 class="chat-username text-muted">{{ !!(message.from._id === this.loggedInUser._id) ? (this.loggedInUser.firstName + ' ' + this.loggedInUser.lastName) 
              : (message.from.firstName + ' ' + message.from.lastName) }}</h5> -->
            <div class="conversation-msg" [@flyInOut]="'in'">
              {{message.content}}
            </div>
            <p class="chat-date text-muted" [@flyInOut]="'in'">{{message.sentAt | date:'EEEE, MMM d, y, h:mm a'}}</p>
          </div>
        </div>



      </div>

      <!-- <mat-divider style="position:sticky; bottom: 11.65%;"></mat-divider> -->

      <!-- Input box and send button -->
      <div class="chat-input-actions" fxLayout="row" style="position: sticky; bottom: 20px; background-color: rgb(255, 255, 255); flex-direction: row; box-sizing: border-box; display: flex; border-radius: 25px; margin: 10px 10px 15px; box-shadow: rgba(150, 150, 150, 0.2) 0px 10px 6px -6px; border-style: solid; border-color: rgba(245, 245, 245, 0.9); border-width: 1px; padding: 10px;">
        <mat-form-field class="full-width mr-1">
          <input [(ngModel)]="messageEntered" matInput placeholder="Make a BEAT â™¥" value="">
        </mat-form-field>
        <button mat-fab color="primary" (click)="sendMessageClicked()">
          <mat-icon>send</mat-icon>
        </button>
      </div>

    </div>
  </mat-sidenav-container>
</mat-card>
